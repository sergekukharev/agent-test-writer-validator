name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: make build

      - name: Test with coverage
        run: go test -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage report
        if: success()
        id: coverage
        run: |
          REPORT=$(go tool cover -func=coverage.out)
          TOTAL=$(echo "$REPORT" | tail -1 | awk '{print $NF}')

          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"

          {
            echo 'report<<EOF'
            echo "$REPORT"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          # Save total for baseline artifact
          echo "$TOTAL" > coverage-total.txt

      - name: Upload coverage baseline
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-baseline
          path: coverage-total.txt
          overwrite: true

      - name: Download previous baseline
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RUN_ID=$(gh run list \
            --branch main \
            --status success \
            --workflow CI \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -n "$RUN_ID" ]; then
            gh run download "$RUN_ID" \
              --name coverage-baseline \
              --dir /tmp/baseline 2>/dev/null || true
          fi

      - name: Write job summary
        if: success()
        run: |
          CURRENT="${{ steps.coverage.outputs.total }}"

          # Read previous baseline if available
          PREVIOUS=""
          if [ -f /tmp/baseline/coverage-total.txt ]; then
            PREVIOUS=$(cat /tmp/baseline/coverage-total.txt)
          fi

          {
            echo "## Test Coverage"
            echo ""

            if [ -n "$PREVIOUS" ]; then
              # Strip % for arithmetic
              CUR_NUM=${CURRENT%\%}
              PREV_NUM=${PREVIOUS%\%}
              DELTA=$(awk "BEGIN {printf \"%.1f\", $CUR_NUM - $PREV_NUM}")

              if (( $(awk "BEGIN {print ($DELTA > 0)}") )); then
                ICON=":arrow_up:"
                SIGN="+"
              elif (( $(awk "BEGIN {print ($DELTA < 0)}") )); then
                ICON=":arrow_down:"
                SIGN=""
              else
                ICON=":white_check_mark:"
                SIGN=""
              fi

              echo "| | Coverage |"
              echo "|---|---|"
              echo "| Previous (main) | ${PREVIOUS} |"
              echo "| Current | ${CURRENT} |"
              echo "| Delta | ${ICON} ${SIGN}${DELTA}% |"
            else
              echo "**Coverage: ${CURRENT}**"
              echo ""
              echo "_No baseline from main available yet for comparison._"
            fi

            echo ""
            echo "<details>"
            echo "<summary>Full coverage report</summary>"
            echo ""
            echo '```'
            echo "${{ steps.coverage.outputs.report }}"
            echo '```'
            echo ""
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment coverage on PR
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT="${{ steps.coverage.outputs.total }}"

          PREVIOUS=""
          if [ -f /tmp/baseline/coverage-total.txt ]; then
            PREVIOUS=$(cat /tmp/baseline/coverage-total.txt)
          fi

          {
            echo "## Test Coverage Report"
            echo ""

            if [ -n "$PREVIOUS" ]; then
              CUR_NUM=${CURRENT%\%}
              PREV_NUM=${PREVIOUS%\%}
              DELTA=$(awk "BEGIN {printf \"%.1f\", $CUR_NUM - $PREV_NUM}")

              if (( $(awk "BEGIN {print ($DELTA > 0)}") )); then
                SIGN="+"
              else
                SIGN=""
              fi

              echo "| | Coverage |"
              echo "|---|---|"
              echo "| Previous (main) | ${PREVIOUS} |"
              echo "| Current | ${CURRENT} |"
              echo "| Delta | ${SIGN}${DELTA}% |"
            else
              echo "**Coverage: ${CURRENT}**"
            fi

            echo ""
            echo "<details>"
            echo "<summary>Full report</summary>"
            echo ""
            echo '```'
            echo "${{ steps.coverage.outputs.report }}"
            echo '```'
            echo ""
            echo "</details>"
          } > /tmp/pr-comment.md

          BODY=$(cat /tmp/pr-comment.md)

          # Delete previous coverage comments to avoid clutter
          gh api \
            "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --jq '.[] | select(.body | startswith("## Test Coverage Report")) | .id' \
          | while read -r id; do
            gh api -X DELETE "repos/${{ github.repository }}/issues/comments/$id"
          done

          gh pr comment "${{ github.event.pull_request.number }}" --body "$BODY"
